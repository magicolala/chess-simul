# Supabase workspace

This directory holds database migrations, seed data, and generated types for the Supabase backend.

## Layout

- `migrations/`: SQL migrations generated by the Supabase CLI.
- `seed.sql`: Seed data to quickly bootstrap local environments.
- `types/`: Generated TypeScript types from your Supabase schema.

## Quick start

1. Install the Supabase CLI: https://supabase.com/docs/guides/cli
2. Log in and link your project: `supabase login` then `supabase link --project-ref <ref>`.
3. Start the local stack: `npm run supabase:start` (requires Docker).
4. Apply migrations: `npm run supabase:db:push` (or `supabase migration up` if you prefer raw CLI commands).
5. Load seed data and reset local state: `npm run supabase:reset`.
6. Generate TypeScript types from the linked project: `npm run supabase:gen:types`.

If you want to start the stack and automatically run all pending migrations in one step, use `npm run supabase:migrate:up`. It calls `supabase start` followed by `supabase migration up --all`, and will reuse `supabase/.env` automatically when it exists.

## Edge functions

- `functions/submit-move`: applies and validates a chess move server-side. It reads the current FEN, checks that the caller owns the turn, rejects illegal UCI coordinates, and persists the resulting FEN + move metadata atomically. The frontend should call it with `supabase.functions.invoke('submit-move', { body: { game_id, uci } })` instead of writing to `games`/`moves` directly.

When serving locally, run `supabase functions serve submit-move --env-file supabase/.env` so the function can reach your linked database with the service role key. The `Authorization: Bearer <access_token>` header is still required to identify the player.

The migration `20250223000007_initial_conventions.sql` enables `pgcrypto`/`uuid-ossp` and provides the `default_uuid` and `handle_timestamps` helpers. Future tables should:

- Use `public` schema with `uuid` primary keys defaulting to `default_uuid()`.
- Add `created_at timestamptz not null default timezone('utc', now())` and `updated_at timestamptz not null default timezone('utc', now())` columns.
- Attach `before insert or update` triggers to call `handle_timestamps`.

Keep database credentials in environment variables (e.g., `.env.local` at the repo root) rather than committing them.

## Edge functions

### `submit-move`

- Validates the authenticated user, ensures it is their turn, and applies a UCI move using `chess.js`.
- Rejects illegal moves and updates both the `moves` table (with `ply`, `uci`, `san`, `fen_after`, `played_by`) and the parent `games` row (`fen`, `turn`, `last_move_uci`, `move_count`, `status`, `updated_at`).
- RLS now blocks direct client updates to `games` and inserts into `moves`; moves must go through this function or the service role.

**Local serve**: `supabase functions serve submit-move --env-file supabase/.env` (ensure `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` are present).

**Client usage** (Angular example):

```ts
const { data, error } = await supabase.functions.invoke('submit-move', {
  body: { game_id: '<game uuid>', uci: 'e2e4' }
});
```

## Supabase helper tests

Two Deno suites cover helpers that are shared between the Edge functions and any other scripts:

1. `time_control_test.ts` asserts that `_shared/time-control.ts` parses `MM+SS` strings consistently.
2. `supabase_client_test.ts` ensures `_shared/supabase-client.ts` fails early when the required env vars are missing.

Run them with the CLI so Deno can fetch dependencies and access environment state:

```bash
cd /path/to/repo
deno test --allow-net --allow-env supabase/tests
```

## Integration smoke tests

The integration suite simulates real matchmaking, move submission, and realtime flows against a Supabase Cloud project.
It requires test-specific credentials so the suite can create users, insert games, and subscribe to realtime channels with a service role.

Set the following variables before running the suite:

```bash
export SUPABASE_TEST_URL=https://<your-test-project>.supabase.co
export SUPABASE_TEST_ANON_KEY=<anon-public-key>
export SUPABASE_TEST_SERVICE_ROLE_KEY=<service-role-key>
```

Run the suite with:

```bash
deno test --allow-net --allow-env supabase/tests/integration
```

The tests clean up after themselves (queues, games, and generated users) so they can run repeatedly in CI or locally.

The suite is intentionally small and fast; adding these checks to CI keeps those helpers from regressing.

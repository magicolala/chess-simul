# Supabase workspace

This directory holds database migrations, seed data, and generated types for the Supabase backend.

## Layout
- `migrations/`: SQL migrations generated by the Supabase CLI.
- `seed.sql`: Seed data to quickly bootstrap local environments.
- `types/`: Generated TypeScript types from your Supabase schema.

## Quick start
1. Install the Supabase CLI: https://supabase.com/docs/guides/cli
2. Log in and link your project: `supabase login` then `supabase link --project-ref <ref>`.
3. Start the local stack: `npm run supabase:start` (requires Docker).
4. Apply migrations: `npm run supabase:db:push` (or `supabase migration up` if you prefer raw CLI commands).
5. Load seed data and reset local state: `npm run supabase:reset`.
6. Generate TypeScript types from the linked project: `npm run supabase:gen:types`.

The migration `20250223000007_initial_conventions.sql` enables `pgcrypto`/`uuid-ossp` and provides the `default_uuid` and `handle_timestamps` helpers. Future tables should:
- Use `public` schema with `uuid` primary keys defaulting to `default_uuid()`.
- Add `created_at timestamptz not null default timezone('utc', now())` and `updated_at timestamptz not null default timezone('utc', now())` columns.
- Attach `before insert or update` triggers to call `handle_timestamps`.

Keep database credentials in environment variables (e.g., `.env.local` at the repo root) rather than committing them.

## Edge functions

### `submit-move`

- Validates the authenticated user, ensures it is their turn, and applies a UCI move using `chess.js`.
- Rejects illegal moves and updates both the `moves` table (with `ply`, `uci`, `san`, `fen_after`, `played_by`) and the parent `games` row (`fen`, `turn`, `last_move_uci`, `move_count`, `status`, `updated_at`).
- RLS now blocks direct client updates to `games` and inserts into `moves`; moves must go through this function or the service role.

**Local serve**: `supabase functions serve submit-move --env-file supabase/.env` (ensure `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` are present).

**Client usage** (Angular example):

```ts
const { data, error } = await supabase.functions.invoke('submit-move', {
  body: { game_id: '<game uuid>', uci: 'e2e4' }
});
```

<!-- Main Container -->
@if (auth.currentUser() && auth.currentUser()?.emailVerified && auth.currentUser()?.onboardingCompleted) {
  <!-- App Shell (Authenticated & Onboarded) -->
  <div class="min-h-screen bg-nano-banana dark:bg-[#121212] text-[#1D1C1C] dark:text-white flex font-sans overflow-hidden transition-colors duration-300">
    
    <!-- Sidebar (Fixed Width) -->
    <aside class="w-72 bg-white dark:bg-[#1a1a1a] border-r-2 border-[#1D1C1C] dark:border-white flex flex-col z-20 shadow-none overflow-y-auto transition-colors duration-300">
      
      <!-- Brand -->
      <div class="p-6 border-b-2 border-[#1D1C1C] dark:border-white flex items-center space-x-3 cursor-pointer" routerLink="/dashboard">
        <div class="w-10 h-10 bg-[#FFF48D] text-[#1D1C1C] flex items-center justify-center border-2 border-[#1D1C1C] wero-shadow-sm text-2xl">
          â™Ÿ
        </div>
        <h1 class="text-xl font-black font-display text-[#1D1C1C] dark:text-white tracking-tighter uppercase">
          Chess<br />Master
        </h1>
      </div>

      <!-- Navigation -->
      <div class="flex-1 py-6 px-4 space-y-8">
        
        <!-- Menu Principal -->
        <div>
          <h3 class="text-xs font-black font-display text-gray-400 uppercase tracking-widest mb-4 px-2">
            Menu Principal
          </h3>
          <nav class="space-y-2">
            <!-- Dashboard -->
            <a routerLink="/dashboard" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">ğŸ“Š</span> Tableau de bord
            </a>

            <!-- Local Game -->
            <a routerLink="/game" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">â™Ÿï¸</span> Table de jeu
            </a>

            <!-- Multiplayer -->
            <a routerLink="/play" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">ğŸŒ</span> Multijoueur
            </a>

            <!-- My Games -->
            <a routerLink="/games" routerLinkActive="bg-[#7AF7F7] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center justify-between transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span><span class="mr-3 text-lg">ğŸ®</span> Mes Parties</span>
              @if (matchmakingService.activeGames().length > 0) {
                <span class="bg-[#1D1C1C] text-white text-[10px] font-black px-1.5 py-0.5 rounded-full">
                  {{ matchmakingService.activeGames().length }}
                </span>
              }
            </a>

            <!-- Simuls -->
            <a routerLink="/simuls" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">âš”ï¸</span> SimultanÃ©es
            </a>

             <!-- Round Robin -->
             <a routerLink="/round-robin-simul" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">ğŸ”</span> Round Robin
            </a>

            <!-- Analysis -->
            <a routerLink="/analysis" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">ğŸ”¬</span> Analyse
            </a>

            <!-- Social -->
            <a routerLink="/social" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">ğŸ’¬</span> CommunautÃ©
            </a>

            <!-- History -->
            <a routerLink="/history" routerLinkActive="bg-[#FFF48D] border-[#1D1C1C] wero-shadow-sm text-[#1D1C1C]" 
               class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px] cursor-pointer">
              <span class="mr-3 text-lg">ğŸ•’</span> Historique
            </a>
          </nav>
        </div>

        <!-- Account -->
        <div>
          <h3 class="text-xs font-black font-display text-gray-400 uppercase tracking-widest mb-4 px-2">
            Compte
          </h3>
          <nav class="space-y-2">
            <button (click)="openSettings()" 
                    class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center transition-all border-2 border-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-[2px]">
              <span class="mr-3 text-lg">âš™ï¸</span> ParamÃ¨tres
            </button>
            <button (click)="handleLogout()" 
                    class="w-full text-left px-4 py-3 font-bold font-display text-sm flex items-center border-2 border-transparent text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-[2px]">
              <span class="mr-3 text-lg">ğŸšª</span> DÃ©connexion
            </button>
          </nav>
        </div>
      </div>
    </aside>

    <!-- Main Content Layout -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden">
      <!-- Top Bar -->
      <header class="h-20 bg-white dark:bg-[#1a1a1a] border-b-2 border-[#1D1C1C] dark:border-white flex items-center justify-between px-8 flex-shrink-0 transition-colors duration-300">
        <!-- Search -->
        <div class="relative w-96">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
          <input type="text" placeholder="Rechercher un joueur..." 
                 class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:border-[#1D1C1C] dark:focus:border-white focus:bg-[#FFF48D]/20 outline-none font-medium transition-colors text-sm rounded-[2px]" />
        </div>

        <!-- Right Actions -->
        <div class="flex items-center space-x-6">
          <div class="flex items-center pl-6 border-l-2 border-gray-100 dark:border-gray-800 cursor-pointer hover:opacity-80" 
               [routerLink]="['/u', auth.currentUser()!.id]">
            <div class="text-right mr-3 hidden md:block">
              <p class="text-sm font-black font-display text-[#1D1C1C] dark:text-white leading-none">
                {{ auth.currentUser()?.name }}
              </p>
              <p class="text-[10px] text-gray-500 dark:text-gray-400 font-bold mt-1">
                ELO: {{ currentElo() }}
              </p>
            </div>
            <img [src]="auth.currentUser()?.avatar" class="w-10 h-10 border-2 border-[#1D1C1C] dark:border-white bg-gray-100 rounded-[2px]" />
          </div>
        </div>
      </header>

      <!-- Content Scrollable Area -->
      <main class="flex-1 overflow-y-auto transition-colors duration-300">
         <router-outlet></router-outlet>
      </main>
    </div>

    <!-- NEW GAME MODAL (Local) -->
    @if (ui.showNewGameModal()) {
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-[#1D1C1C]/80 backdrop-blur-sm" (click)="ui.closeNewGameModal()"></div>
        <div class="bg-white dark:bg-[#1a1a1a] w-full max-w-lg border-2 border-[#1D1C1C] dark:border-white wero-shadow relative z-10 p-8 animate-in fade-in zoom-in duration-200">
          <h2 class="text-3xl font-black font-display text-[#1D1C1C] dark:text-white uppercase mb-6 flex items-center">
            <span class="bg-[#FFF48D] text-black w-8 h-8 flex items-center justify-center border-2 border-black mr-3 text-lg">+</span>
            Nouvelle Partie (Local)
          </h2>
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-bold font-display text-gray-500 uppercase mb-2">Cadence (Temps)</label>
              <div class="flex space-x-4">
                <button (click)="updateTimeConfig(3)" [class.bg-[#1D1C1C]]="newGameConfig().timeMinutes === 3" [class.text-white]="newGameConfig().timeMinutes === 3" class="flex-1 py-3 border-2 border-[#1D1C1C] dark:border-white font-black font-display dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800">
                  3 min
                </button>
                <button (click)="updateTimeConfig(5)" [class.bg-[#1D1C1C]]="newGameConfig().timeMinutes === 5" [class.text-white]="newGameConfig().timeMinutes === 5" class="flex-1 py-3 border-2 border-[#1D1C1C] dark:border-white font-black font-display dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800">
                  5 min
                </button>
                <button (click)="updateTimeConfig(10)" [class.bg-[#1D1C1C]]="newGameConfig().timeMinutes === 10" [class.text-white]="newGameConfig().timeMinutes === 10" class="flex-1 py-3 border-2 border-[#1D1C1C] dark:border-white font-black font-display dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800">
                  10 min
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-bold font-display text-gray-500 uppercase mb-2">Mode de jeu</label>
              <div class="grid grid-cols-2 gap-3">
                <button (click)="updateGameMode('standard')" class="py-3 border-2 border-[#1D1C1C] dark:border-white font-black font-display text-sm uppercase" [class.bg-[#1D1C1C]]="newGameConfig().gameMode === 'standard'" [class.text-white]="newGameConfig().gameMode === 'standard'">
                  Classique
                </button>
                <button (click)="updateGameMode('hand_brain')" class="py-3 border-2 border-[#1D1C1C] dark:border-white font-black font-display text-sm uppercase" [class.bg-[#1D1C1C]]="newGameConfig().gameMode === 'hand_brain'" [class.text-white]="newGameConfig().gameMode === 'hand_brain'">
                  ğŸ§  Main-Cerveau
                </button>
              </div>
            </div>
            <button (click)="startNewSession()" class="w-full py-4 bg-[#7AF7F7] hover:bg-[#FFF48D] border-2 border-[#1D1C1C] dark:border-white text-[#1D1C1C] font-black font-display text-xl uppercase transition-colors wero-shadow-sm active:translate-y-[2px] active:shadow-none">
              Jouer (Pass & Play)
            </button>
          </div>
        </div>
      </div>
    }

    <!-- SETTINGS MODAL -->
    @if (ui.showSettingsModal()) {
      <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-[#1D1C1C]/80 backdrop-blur-sm" (click)="closeSettings()"></div>
        <div class="bg-white dark:bg-[#1a1a1a] w-full max-w-4xl h-[85vh] border-2 border-[#1D1C1C] dark:border-white wero-shadow relative z-10 animate-in fade-in zoom-in duration-200 overflow-hidden">
          <app-settings (close)="closeSettings()"></app-settings>
        </div>
      </div>
    }

  </div>
} @else {
  <!-- Public Flow (Landing, Login, Register) is now handled by Router -->
  <router-outlet></router-outlet>
}
